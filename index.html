<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard IoT - ThingSpeak</title>
  <style>
    :root{
      --bg: #0f172a;
      --panel: #111827;
      --ink: #e5e7eb;
      --muted: #94a3b8;
      --brand: #22d3ee;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --card: #0b1220;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; margin:0; padding:0 }
    body{
      background: radial-gradient(1200px 800px at 10% -10%, #172554 0%, transparent 50%), var(--bg);
      color: var(--ink);
      font: 500 16px/1.5 system-ui, sans-serif;
    }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px }
    header{ display:flex; align-items:center; gap:14px; margin-bottom:20px }
    .logo{ width:44px; height:44px; border-radius:12px; background:linear-gradient(135deg,#0ea5e9,#22d3ee); display:grid; place-items:center; box-shadow:var(--shadow) }
    h1{ font-size:clamp(20px,2.5vw,28px); font-weight:800 }
    .toolbar{ display:flex; gap:10px; margin-left:auto; align-items:center; flex-wrap:wrap }
    .toolbar input, .toolbar select, .toolbar button{
      padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.1);
      background:var(--panel); color:var(--ink);
    }
    .grid{ display:grid; gap:16px }
    /* KPIs */
    .kpis{ grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) }
    .kpi{ padding:16px; background:var(--card); border-radius:var(--radius); border:1px solid rgba(255,255,255,.06) }
    .kpi h3{ font-size:13px; color:var(--muted); margin-bottom:6px }
    .kpi .val{ font-size:28px; font-weight:800 }
    .kpi .unit{ font-size:14px; color:var(--muted); margin-left:6px }
    /* Charts */
    .charts{ grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) }
    .chart{ padding:8px; background:var(--panel); border-radius:var(--radius) }
    .chart h4{ font-size:14px; color:var(--muted); margin:6px 10px }
    .chart iframe{ width:100%; height:300px; border:0; border-radius:14px; background:#010409 }
    .foot{ margin-top:20px; text-align:center; font-size:12px; color:var(--muted) }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">ðŸ“¡</div>
      <h1>Dashboard IoT - ThingSpeak</h1>
      <div class="toolbar">
        <input id="channel" placeholder="Channel ID">
        <input id="apikey" placeholder="Read API Key (se necessÃ¡rio)">
        <select id="range">
          <option value="1">Ãšltimo dia</option>
          <option value="7">7 dias</option>
          <option value="30">30 dias</option>
        </select>
        <select id="smooth">
          <option value="">Sem mÃ©dia</option>
          <option value="10">MÃ©dia 10 pts</option>
          <option value="60">MÃ©dia 60 pts</option>
        </select>
        <button onclick="atualizar()">Atualizar</button>
      </div>
    </header>

    <!-- KPIs -->
    <div class="grid kpis" id="cards">
      <div class="kpi card" data-field="1" data-title="Temperatura">
        <h3>Temperatura</h3>
        <div class="val"><span id="field1">--</span><span class="unit">Â°C</span></div>
      </div>
      <div class="kpi card" data-field="2" data-title="Umidade">
        <h3>Umidade</h3>
        <div class="val"><span id="field2">--</span><span class="unit">%</span></div>
      </div>
      <div class="kpi card" data-field="3" data-title="Luminosidade">
        <h3>Luminosidade</h3>
        <div class="val"><span id="field3">--</span><span class="unit">lx</span></div>
      </div>
      <div class="kpi card" data-field="4" data-title="PressÃ£o">
        <h3>PressÃ£o</h3>
        <div class="val"><span id="field4">--</span><span class="unit">hPa</span></div>
      </div>
    </div>

    <!-- GrÃ¡ficos -->
    <div class="grid charts">
      <div class="chart card" data-field="1" data-title="Temperatura"><h4>Temperatura</h4><iframe></iframe></div>
      <div class="chart card" data-field="2" data-title="Umidade"><h4>Umidade</h4><iframe></iframe></div>
      <div class="chart card" data-field="3" data-title="Luminosidade"><h4>Luminosidade</h4><iframe></iframe></div>
      <div class="chart card" data-field="4" data-title="PressÃ£o"><h4>PressÃ£o</h4><iframe></iframe></div>
    </div>

    <div class="foot">Powered by ThingSpeak</div>
  </div>

  <script>
    const channelInput = document.getElementById('channel');
    const keyInput = document.getElementById('apikey');
    const rangeSel = document.getElementById('range');
    const smoothSel = document.getElementById('smooth');

    function qs(sel, el=document){ return el.querySelector(sel) }
    function qsa(sel, el=document){ return [...el.querySelectorAll(sel)] }

    function montarURL(channel, field, days, avg, key, title){
      const params = new URLSearchParams({
        dynamic:'true',
        days:String(days),
        bgcolor:'transparent',
        color:'white'
      });
      if (avg) params.set('average', String(avg));
      if (key) params.set('api_key', key);
      if (title) params.set('title', title);
      return `https://thingspeak.com/channels/${channel}/charts/${field}?${params.toString()}`;
    }

    async function atualizar(){
      const channel = channelInput.value.trim();
      const key = keyInput.value.trim();
      const days = rangeSel.value;
      const avg = smoothSel.value;

      if (!channel) return;

      // Atualiza iframes
      qsa('.chart').forEach(card=>{
        const field = card.dataset.field;
        const title = card.dataset.title;
        const url = montarURL(channel, field, days, avg, key, title);
        const frame = qs('iframe', card);
        if (frame.dataset.src !== url){
          frame.dataset.src = url;
          frame.src = url;
        }
      });

      // Atualiza valores atuais
      try{
        const resp = await fetch(`https://api.thingspeak.com/channels/${channel}/feeds.json?results=1&api_key=${key}`);
        const data = await resp.json();
        if (data && data.feeds && data.feeds.length){
          const feed = data.feeds[0];
          for (let i=1; i<=4; i++){
            const val = feed[`field${i}`];
            if (val!==undefined) qs(`#field${i}`).textContent = val;
          }
        }
      }catch(e){ console.error(e) }
    }
  </script>
</body>
</html>
